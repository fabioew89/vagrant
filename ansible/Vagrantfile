# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "debian/bookworm64"

  # Read SSH public key
  ssh_pub_key = File.read(File.join(File.dirname(__FILE__), "keys", "win11.pub")).strip

  (1..3).each do |i|
    config.vm.define "node#{i}" do |node|
      
      node.vm.hostname = "node#{i}"
      node.vm.network "private_network", ip: "192.168.56.1#{i}"

      node.vm.provision "shell", inline: <<-SHELL
        useradd -m -s /bin/bash fabio
        echo "fabio:123" | chpasswd
        usermod -aG sudo fabio

        apt update            > /dev/null 2>&1 
        apt install vim -y    > /dev/null 2>&1

        mkdir -p /home/fabio/.ssh
        echo '#{ssh_pub_key}' >> .ssh/authorized_keys
        chown -R fabio:fabio /home/fabio/.ssh
        chmod 700 /home/fabio/.ssh
        chmod 600 /home/fabio/.ssh/authorized_keys

        # sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        systemctl restart ssh
      SHELL

      node.vm.provider "virtualbox" do |v|
        v.name = "node#{i}"
        v.memory = 512
        v.cpus = 1
      end
    end
  end
end
